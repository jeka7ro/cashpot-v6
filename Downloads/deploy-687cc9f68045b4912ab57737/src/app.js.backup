import React, { createContext, useContext, useEffect, useState } from 'react';
import './App.css';

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;
const API = `${BACKEND_URL}/api`;

// Auth Context
const AuthContext = createContext();

// Avatar Upload Component
const AvatarUpload = ({ entityType, entityId, currentAvatar, onAvatarChange }) => {
  const [uploading, setUploading] = useState(false);
  const [dragOver, setDragOver] = useState(false);
  const { user } = useAuth();

  const handleFileUpload = async (file) => {
    if (!file || !file.type.startsWith('image/')) {
      alert('Please select a valid image file');
      return;
    }

    if (file.size > 5 * 1024 * 1024) { // 5MB limit
      alert('File size must be less than 5MB');
      return;
    }

    setUploading(true);
    try {
      // Convert file to base64
      const base64 = await new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(file);
      });

      // Upload to backend
      const response = await fetch(`${API}/attachments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          filename: `avatar_${Date.now()}.${file.name.split('.').pop()}`,
          original_filename: file.name,
          file_size: file.size,
          mime_type: file.type,
          file_data: base64,
          entity_type: entityType,
          entity_id: entityId
        })
      });

      if (response.ok) {
        const attachment = await response.json();
        onAvatarChange(attachment);
      } else {
        throw new Error('Upload failed');
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('Failed to upload avatar');
    } finally {
      setUploading(false);
    }
  };

  const handleDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    const file = e.dataTransfer.files[0];
    if (file) handleFileUpload(file);
  };

  const handleFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) handleFileUpload(file);
  };

  return (
    <div className="avatar-upload-container">
      <div
        className={`avatar-upload ${dragOver ? 'drag-over' : ''}`}
        onDrop={handleDrop}
        onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
        onDragLeave={() => setDragOver(false)}
        onClick={() => document.getElementById(`avatar-input-${entityId}`)?.click()}
      >
        {currentAvatar ? (
          <img
            src={`data:${currentAvatar.mime_type};base64,${currentAvatar.file_data}`}
            alt="Avatar"
            className="avatar-preview"
          />
        ) : (
          <div className="avatar-placeholder">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <span>Click or drag to upload avatar</span>
          </div>
        )}
        {uploading && (
          <div className="upload-overlay">
            <div className="spinner"></div>
          </div>
        )}
      </div>
      <input
        type="file"
        id={`avatar-input-${entityId}`}
        accept="image/*"
        style={{ display: 'none' }}
        onChange={handleFileSelect}
      />
    </div>
  );
};

// Custom hook for fetching avatars
const useAvatar = (entityType, entityId) => {
  const [avatar, setAvatar] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchAvatar = async () => {
    if (!entityType || !entityId) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API}/attachments/${entityType}/${entityId}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      if (response.ok) {
        const attachments = await response.json();
        // Find the first image attachment as avatar
        const avatarAttachment = attachments.find(att => 
          att.mime_type.startsWith('image/') && 
          att.filename.includes('avatar')
        );
        setAvatar(avatarAttachment || null);
      }
    } catch (error) {
      console.error('Error fetching avatar:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchAvatar();
  }, [entityType, entityId]);

  return { avatar, setAvatar, loading, refetch: fetchAvatar };
};

// Avatar Display Component (for tables)
const AvatarDisplay = ({ entityType, entityId, size = 40 }) => {
  const { avatar, loading } = useAvatar(entityType, entityId);

  if (loading) {
    return (
      <div className="avatar-display loading" style={{ width: size, height: size }}>
        <div className="spinner-small"></div>
      </div>
    );
  }

  if (avatar) {
    return (
      <img
        src={`data:${avatar.mime_type};base64,${avatar.file_data}`}
        alt="Avatar"
        className="avatar-display"
        style={{ width: size, height: size }}
      />
    );
  }

  // Default avatar with initials or icon
  return (
    <div className="avatar-display default" style={{ width: size, height: size }}>
      <svg width={size * 0.6} height={size * 0.6} viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </div>
  );
};

const AuthProvider = ({ children }) => {
  const [avatar, setAvatar] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchAvatar = async () => {
    if (!entityType || !entityId) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API}/attachments/${entityType}/${entityId}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      if (response.ok) {
        const attachments = await response.json();
        // Find the first image attachment as avatar
        const avatarAttachment = attachments.find(att => 
          att.mime_type.startsWith('image/') && 
          att.filename.includes('avatar')
        );
        setAvatar(avatarAttachment || null);
      }
    } catch (error) {
      console.error('Error fetching avatar:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchAvatar();
  }, [entityType, entityId]);

  return { avatar, setAvatar, loading, refetch: fetchAvatar };
};

// Avatar Display Component (for tables)
const AvatarDisplay = ({ entityType, entityId, size = 40 }) => {
  const { avatar, loading } = useAvatar(entityType, entityId);

  if (loading) {
    return (
      <div className="avatar-display loading" style={{ width: size, height: size }}>
        <div className="spinner-small"></div>
      </div>
    );
  }

  if (avatar) {
    return (
      <img
        src={`data:${avatar.mime_type};base64,${avatar.file_data}`}
        alt="Avatar"
        className="avatar-display"
        style={{ width: size, height: size }}
      />
    );
  }

  // Default avatar with initials or icon
  return (
    <div className="avatar-display default" style={{ width: size, height: size }}>
      <svg width={size * 0.6} height={size * 0.6} viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </div>
  );
};
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const token = localStorage.getItem('token');
    if (token) {
      fetch(`${API}/auth/me`, {
        headers: { Authorization: `Bearer ${token}` }
      })
        .then(res => res.json())
        .then(data => {
          if (data.id) {
            setUser(data);
          } else {
            localStorage.removeItem('token');
          }
        })
        .catch(() => localStorage.removeItem('token'))
        .finally(() => setLoading(false));
    } else {
      setLoading(false);
    }
  }, []);

  const login = async (username, password) => {
    const response = await fetch(`${API}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    });
    const data = await response.json();
    if (response.ok) {
      localStorage.setItem('token', data.access_token);
      setUser(data.user);
      return true;
    }
    throw new Error(data.detail || 'Login failed');
  };

  const logout = () => {
    localStorage.removeItem('token');
    setUser(null);
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading }}>
      {children}
    </AuthContext.Provider>
  );
};

const useAuth = () => useContext(AuthContext);

// Custom hook for fetching avatars
const useAvatar = (entityType, entityId) => {
  const [avatar, setAvatar] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchAvatar = async () => {
    if (!entityType || !entityId) return;
    
    setLoading(true);
    try {
      const response = await fetch(`${API}/attachments/${entityType}/${entityId}`, {
        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
      });
      
      if (response.ok) {
        const attachments = await response.json();
        // Find the first image attachment as avatar
        const avatarAttachment = attachments.find(att => 
          att.mime_type.startsWith('image/') && 
          att.filename.includes('avatar')
        );
        setAvatar(avatarAttachment || null);
      }
    } catch (error) {
      console.error('Error fetching avatar:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchAvatar();
  }, [entityType, entityId]);

  return { avatar, setAvatar, loading, refetch: fetchAvatar };
};

// Avatar Display Component (for tables)
const AvatarDisplay = ({ entityType, entityId, size = 40 }) => {
  const { avatar, loading } = useAvatar(entityType, entityId);

  if (loading) {
    return (
      <div className="avatar-display loading" style={{ width: size, height: size }}>
        <div className="spinner-small"></div>
      </div>
    );
  }

  if (avatar) {
    return (
      <img
        src={`data:${avatar.mime_type};base64,${avatar.file_data}`}
        alt="Avatar"
        className="avatar-display"
        style={{ width: size, height: size }}
      />
    );
  }

  // Default avatar with initials or icon
  return (
    <div className="avatar-display default" style={{ width: size, height: size }}>
      <svg width={size * 0.6} height={size * 0.6} viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
      </svg>
    </div>
  );
};

// Login Component
const Login = () => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const { login } = useAuth();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);
    
    try {
      await login(username, password);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="login-container">
      <div className="login-background">
        <img 
          src="https://images.unsplash.com/photo-1563753159011-f1d8b8272c8c?crop=entropy&cs=srgb&fm=jpg&ixid=M3w3NTY2Njd8MHwxfHNlYXJjaHwzfHxwcm9mZXNzaW9uYWwlMjBkYXNoYm9hcmR8ZW58MHx8fGJsYWNrfDE3NTIxNDI5NTZ8MA&ixlib=rb-4.1.0&q=85"
          alt="Professional dashboard"
          className="login-bg-image"
        />
        <div className="login-overlay"></div>
      </div>
      
      <div className="login-card">
        <div className="login-header">
          <h1>Financial Planner Pro</h1>
          <p>Gaming Industry Management System</p>
        </div>
        
        <form onSubmit={handleSubmit} className="login-form">
          <div className="form-group">
            <label htmlFor="username">Username</label>
            <input
              type="text"
              id="username"
              value={username}
              onChange={(e) => setUsername(e.target.value)}
              required
              className="form-input"
              placeholder="Enter your username"
            />
          </div>
          
          <div className="form-group">
            <label htmlFor="password">Password</label>
            <input
              type="password"
              id="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              className="form-input"
              placeholder="Enter your password"
            />
          </div>
          
          {error && <div className="error-message">{error}</div>}
          
          <button type="submit" disabled={loading} className="login-button">
            {loading ? 'Signing in...' : 'Sign In'}
          </button>
        </form>
        
        <div className="login-footer">
          <p>Demo Admin: admin / password</p>
          <p>Contact your administrator for access</p>
        </div>
      </div>
    </div>
  );
};

// Generic Entity Form Component
const EntityForm = ({ entityType, entity, onSave, onClose, companiesLocations, providers, cabinets, gameMixes }) => {
  const [formData, setFormData] = useState({});

  useEffect(() => {
    // Initialize form data based on entity type
    if (entity) {
      setFormData(entity);
    } else {
      setFormData(getDefaultFormData(entityType));
    }
  }, [entity, entityType]);

  const getDefaultFormData = (type) => {
    const defaults = {
      companies: {
        name: '',
        registration_number: '',
        tax_id: '',
        address: '',
        phone: '',
        email: '',
        website: '',
        contact_person: ''
      },
      locations: {
        name: '',
        address: '',
        city: '',
        county: '',
        country: 'Romania',
        postal_code: '',
        company_id: '',
        manager_id: ''
      },
      providers: {
        name: '',
        company_name: '',
        contact_person: '',
        email: '',
        phone: '',
        address: '',
        website: ''
      },
      cabinets: {
        serial_number: '',
        model: '',
        manufacturer: '',
        provider_id: '',
        location_id: '',
        installation_date: '',
        last_maintenance: ''
      },
      slots: {
        cabinet_id: '',
        game_mix_id: '',
        model: '',
        denomination: 0.10,
        max_bet: 100.00,
        rtp: 95.00,
        gaming_places: 1,
        commission_date: ''
      },
      gamemixes: {
        name: '',
        description: '',
        provider_id: '',
        games: []
      },
      invoices: {
        invoice_number: '',
        company_id: '',
        location_id: '',
        issue_date: '',
        due_date: '',
        amount: 0,
        currency: 'EUR',
        description: ''
      },
      onjn: {
        report_number: '',
        report_type: 'monthly',
        company_id: '',
        location_id: '',
        report_date: '',
        equipment_data: {}
      },
      legal: {
        title: '',
        document_type: 'license',
        company_id: '',
        location_id: '',
        issue_date: '',
        expiry_date: '',
        issuing_authority: '',
        description: ''
      }
    };
    return defaults[type] || {};
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleGamesChange = (games) => {
    const gameArray = games.split('\n').filter(game => game.trim());
    setFormData(prev => ({ ...prev, games: gameArray }));
  };

  const renderFormFields = () => {
    switch (entityType) {
      case 'companies':
        return (
          <>
            <div className="form-group">
              <label>Company Name *</label>
              <input
                type="text"
                value={formData.name || ''}
                onChange={(e) => handleChange('name', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Registration Number *</label>
              <input
                type="text"
                value={formData.registration_number || ''}
                onChange={(e) => handleChange('registration_number', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Tax ID *</label>
              <input
                type="text"
                value={formData.tax_id || ''}
                onChange={(e) => handleChange('tax_id', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Address *</label>
              <input
                type="text"
                value={formData.address || ''}
                onChange={(e) => handleChange('address', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Phone *</label>
              <input
                type="tel"
                value={formData.phone || ''}
                onChange={(e) => handleChange('phone', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Email *</label>
              <input
                type="email"
                value={formData.email || ''}
                onChange={(e) => handleChange('email', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Website</label>
              <input
                type="url"
                value={formData.website || ''}
                onChange={(e) => handleChange('website', e.target.value)}
              />
            </div>
            <div className="form-group">
              <label>Contact Person *</label>
              <input
                type="text"
                value={formData.contact_person || ''}
                onChange={(e) => handleChange('contact_person', e.target.value)}
                required
              />
            </div>
          </>
        );

      case 'locations':
        return (
          <>
            <div className="form-group">
              <label>Location Name *</label>
              <input
                type="text"
                value={formData.name || ''}
                onChange={(e) => handleChange('name', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Company *</label>
              <select
                value={formData.company_id || ''}
                onChange={(e) => handleChange('company_id', e.target.value)}
                required
              >
                <option value="">Select Company</option>
                {companiesLocations.companies.map(company => (
                  <option key={company.id} value={company.id}>{company.name}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Address *</label>
              <input
                type="text"
                value={formData.address || ''}
                onChange={(e) => handleChange('address', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>City *</label>
              <input
                type="text"
                value={formData.city || ''}
                onChange={(e) => handleChange('city', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>County *</label>
              <input
                type="text"
                value={formData.county || ''}
                onChange={(e) => handleChange('county', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Country</label>
              <input
                type="text"
                value={formData.country || 'Romania'}
                onChange={(e) => handleChange('country', e.target.value)}
              />
            </div>
            <div className="form-group">
              <label>Postal Code *</label>
              <input
                type="text"
                value={formData.postal_code || ''}
                onChange={(e) => handleChange('postal_code', e.target.value)}
                required
              />
            </div>
          </>
        );

      case 'providers':
        return (
          <>
            <div className="form-group">
              <label>Provider Name *</label>
              <input
                type="text"
                value={formData.name || ''}
                onChange={(e) => handleChange('name', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Company Name *</label>
              <input
                type="text"
                value={formData.company_name || ''}
                onChange={(e) => handleChange('company_name', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Contact Person *</label>
              <input
                type="text"
                value={formData.contact_person || ''}
                onChange={(e) => handleChange('contact_person', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Email *</label>
              <input
                type="email"
                value={formData.email || ''}
                onChange={(e) => handleChange('email', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Phone *</label>
              <input
                type="tel"
                value={formData.phone || ''}
                onChange={(e) => handleChange('phone', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Address *</label>
              <input
                type="text"
                value={formData.address || ''}
                onChange={(e) => handleChange('address', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Website</label>
              <input
                type="url"
                value={formData.website || ''}
                onChange={(e) => handleChange('website', e.target.value)}
              />
            </div>
          </>
        );

      case 'cabinets':
        return (
          <>
            <div className="form-group">
              <label>Serial Number *</label>
              <input
                type="text"
                value={formData.serial_number || ''}
                onChange={(e) => handleChange('serial_number', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Manufacturer *</label>
              <input
                type="text"
                value={formData.manufacturer || ''}
                onChange={(e) => handleChange('manufacturer', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Model *</label>
              <input
                type="text"
                value={formData.model || ''}
                onChange={(e) => handleChange('model', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Provider *</label>
              <select
                value={formData.provider_id || ''}
                onChange={(e) => handleChange('provider_id', e.target.value)}
                required
              >
                <option value="">Select Provider</option>
                {providers.map(provider => (
                  <option key={provider.id} value={provider.id}>{provider.name}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Location *</label>
              <select
                value={formData.location_id || ''}
                onChange={(e) => handleChange('location_id', e.target.value)}
                required
              >
                <option value="">Select Location</option>
                {companiesLocations.locations.map(location => (
                  <option key={location.id} value={location.id}>{location.name}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Installation Date</label>
              <input
                type="date"
                value={formData.installation_date || ''}
                onChange={(e) => handleChange('installation_date', e.target.value)}
              />
            </div>
            <div className="form-group">
              <label>Last Maintenance</label>
              <input
                type="date"
                value={formData.last_maintenance || ''}
                onChange={(e) => handleChange('last_maintenance', e.target.value)}
              />
            </div>
          </>
        );

      case 'slots':
        return (
          <>
            <div className="form-group">
              <label>Cabinet *</label>
              <select
                value={formData.cabinet_id || ''}
                onChange={(e) => handleChange('cabinet_id', e.target.value)}
                required
              >
                <option value="">Select Cabinet</option>
                {cabinets.map(cabinet => (
                  <option key={cabinet.id} value={cabinet.id}>
                    {cabinet.manufacturer} {cabinet.model} - {cabinet.serial_number}
                  </option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Game Mix *</label>
              <select
                value={formData.game_mix_id || ''}
                onChange={(e) => handleChange('game_mix_id', e.target.value)}
                required
              >
                <option value="">Select Game Mix</option>
                {gameMixes.map(mix => (
                  <option key={mix.id} value={mix.id}>{mix.name}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Model *</label>
              <input
                type="text"
                value={formData.model || ''}
                onChange={(e) => handleChange('model', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Denomination (‚Ç¨) *</label>
              <input
                type="number"
                step="0.01"
                value={formData.denomination || ''}
                onChange={(e) => handleChange('denomination', parseFloat(e.target.value))}
                required
              />
            </div>
            <div className="form-group">
              <label>Max Bet (‚Ç¨) *</label>
              <input
                type="number"
                step="0.01"
                value={formData.max_bet || ''}
                onChange={(e) => handleChange('max_bet', parseFloat(e.target.value))}
                required
              />
            </div>
            <div className="form-group">
              <label>RTP (%) *</label>
              <input
                type="number"
                step="0.01"
                value={formData.rtp || ''}
                onChange={(e) => handleChange('rtp', parseFloat(e.target.value))}
                required
              />
            </div>
            <div className="form-group">
              <label>Gaming Places *</label>
              <input
                type="number"
                value={formData.gaming_places || ''}
                onChange={(e) => handleChange('gaming_places', parseInt(e.target.value))}
                required
              />
            </div>
            <div className="form-group">
              <label>Commission Date</label>
              <input
                type="date"
                value={formData.commission_date || ''}
                onChange={(e) => handleChange('commission_date', e.target.value)}
              />
            </div>
          </>
        );

      case 'gamemixes':
        return (
          <>
            <div className="form-group">
              <label>Mix Name *</label>
              <input
                type="text"
                value={formData.name || ''}
                onChange={(e) => handleChange('name', e.target.value)}
                required
              />
            </div>
            <div className="form-group">
              <label>Description *</label>
              <textarea
                value={formData.description || ''}
                onChange={(e) => handleChange('description', e.target.value)}
                required
                rows="3"
              />
            </div>
            <div className="form-group">
              <label>Provider *</label>
              <select
                value={formData.provider_id || ''}
                onChange={(e) => handleChange('provider_id', e.target.value)}
                required
              >
                <option value="">Select Provider</option>
                {providers.map(provider => (
                  <option key={provider.id} value={provider.id}>{provider.name}</option>
                ))}
              </select>
            </div>
            <div className="form-group">
              <label>Games (one per line) *</label>
              <textarea
                value={(formData.games || []).join('\n')}
                onChange={(e) => handleGamesChange(e.target.value)}
                required
                rows="8"
                placeholder="Enter game names, one per line"
              />
            </div>
          </>
        );

      default:
        return <div>Form not implemented for {entityType}</div>;
    }
  };

  const getTitle = () => {
    const titles = {
      companies: 'Company',
      locations: 'Location',
      providers: 'Provider',
      cabinets: 'Cabinet',
      slots: 'Slot Machine',
      gamemixes: 'Game Mix',
      invoices: 'Invoice',
      onjn: 'ONJN Report',
      legal: 'Legal Document'
    };
    return titles[entityType] || 'Entity';
  };

  return (
    <div className="user-edit-modal">
      <div className="modal-backdrop" onClick={onClose}></div>
      <div className="modal-content">
        <div className="modal-header">
          <h2>{entity ? `Edit ${getTitle()}` : `Create ${getTitle()}`}</h2>
          <button className="modal-close" onClick={onClose}>‚úï</button>
        </div>

        <form onSubmit={handleSubmit} className="user-form">
          <div className="form-section">
            <div className="form-grid">
              {renderFormFields()}
            </div>
          </div>

          <div className="form-actions">
            <button type="button" onClick={onClose} className="btn-cancel">
              Cancel
            </button>
            <button type="submit" className="btn-save">
              {entity ? `Update ${getTitle()}` : `Create ${getTitle()}`}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// User Edit Form Component
const UserEditForm = ({ user, onSave, onClose, companiesLocations }) => {
  const [formData, setFormData] = useState({
    username: user?.username || '',
    email: user?.email || '',
    role: user?.role || 'operator',
    password: '',
    is_active: user?.is_active !== false,
    assigned_locations: user?.assigned_locations || [],
    permissions: {
      modules: {
        dashboard: true,
        companies: false,
        locations: false,
        providers: false,
        cabinets: false,
        game_mixes: false,
        slot_machines: false,
        invoices: false,
        onjn_reports: false,
        legal_documents: false,
        users: false
      },
      actions: {
        companies: { create: false, read: false, update: false, delete: false },
        locations: { create: false, read: false, update: false, delete: false },
        providers: { create: false, read: false, update: false, delete: false },
        cabinets: { create: false, read: false, update: false, delete: false },
        game_mixes: { create: false, read: false, update: false, delete: false },
        slot_machines: { create: false, read: false, update: false, delete: false },
        invoices: { create: false, read: false, update: false, delete: false },
        onjn_reports: { create: false, read: false, update: false, delete: false },
        legal_documents: { create: false, read: false, update: false, delete: false },
        users: { create: false, read: false, update: false, delete: false }
      },
      accessible_companies: user?.permissions?.accessible_companies || [],
      accessible_locations: user?.permissions?.accessible_locations || []
    }
  });

  useEffect(() => {
    if (user?.permissions) {
      setFormData(prev => ({
        ...prev,
        permissions: {
          modules: { ...prev.permissions.modules, ...user.permissions.modules },
          actions: { ...prev.permissions.actions, ...user.permissions.actions },
          accessible_companies: user.permissions.accessible_companies || [],
          accessible_locations: user.permissions.accessible_locations || []
        }
      }));
    }
  }, [user]);

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(formData);
  };

  const handleModuleChange = (module, checked) => {
    setFormData(prev => ({
      ...prev,
      permissions: {
        ...prev.permissions,
        modules: {
          ...prev.permissions.modules,
          [module]: checked
        }
      }
    }));
  };

  const handleActionChange = (module, action, checked) => {
    setFormData(prev => ({
      ...prev,
      permissions: {
        ...prev.permissions,
        actions: {
          ...prev.permissions.actions,
          [module]: {
            ...prev.permissions.actions[module],
            [action]: checked
          }
        }
      }
    }));
  };

  const handleCompanyChange = (companyId, checked) => {
    setFormData(prev => ({
      ...prev,
      permissions: {
        ...prev.permissions,
        accessible_companies: checked 
          ? [...prev.permissions.accessible_companies, companyId]
          : prev.permissions.accessible_companies.filter(id => id !== companyId)
      }
    }));
  };

  const handleLocationChange = (locationId, checked) => {
    setFormData(prev => ({
      ...prev,
      permissions: {
        ...prev.permissions,
        accessible_locations: checked 
          ? [...prev.permissions.accessible_locations, locationId]
          : prev.permissions.accessible_locations.filter(id => id !== locationId)
      },
      assigned_locations: checked 
        ? [...prev.assigned_locations, locationId]
        : prev.assigned_locations.filter(id => id !== locationId)
    }));
  };

  const modules = [
    { key: 'dashboard', label: 'Dashboard', icon: 'üìä' },
    { key: 'companies', label: 'Companies', icon: 'üè¢' },
    { key: 'locations', label: 'Locations', icon: 'üìç' },
    { key: 'providers', label: 'Providers', icon: 'üéÆ' },
    { key: 'cabinets', label: 'Cabinets', icon: 'üé∞' },
    { key: 'game_mixes', label: 'Game Mixes', icon: 'üé≤' },
    { key: 'slot_machines', label: 'Slot Machines', icon: 'üéØ' },
    { key: 'invoices', label: 'Invoices', icon: 'üí∞' },
    { key: 'onjn_reports', label: 'ONJN Reports', icon: 'üìã' },
    { key: 'legal_documents', label: 'Legal Documents', icon: 'üìÑ' },
    { key: 'users', label: 'Users', icon: 'üë•' }
  ];

  const actions = [
    { key: 'create', label: 'Create', icon: '‚ûï' },
    { key: 'read', label: 'Read', icon: 'üëÅÔ∏è' },
    { key: 'update', label: 'Update', icon: '‚úèÔ∏è' },
    { key: 'delete', label: 'Delete', icon: 'üóëÔ∏è' }
  ];

  return (
    <div className="user-edit-modal">
      <div className="modal-backdrop" onClick={onClose}></div>
      <div className="modal-content">
        <div className="modal-header">
          <h2>{user ? 'Edit User' : 'Create User'}</h2>
          <button className="modal-close" onClick={onClose}>‚úï</button>
        </div>

        <form onSubmit={handleSubmit} className="user-form">
          {/* Basic User Information */}
          <div className="form-section">
            <h3>User Information</h3>
            <div className="form-grid">
              <div className="form-group">
                <label>Username</label>
                <input
                  type="text"
                  value={formData.username}
                  onChange={(e) => setFormData(prev => ({ ...prev, username: e.target.value }))}
                  required
                />
              </div>
              <div className="form-group">
                <label>Email</label>
                <input
                  type="email"
                  value={formData.email}
                  onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                  required
                />
              </div>
              <div className="form-group">
                <label>Role</label>
                <select
                  value={formData.role}
                  onChange={(e) => setFormData(prev => ({ ...prev, role: e.target.value }))}
                >
                  <option value="admin">Admin</option>
                  <option value="manager">Manager</option>
                  <option value="operator">Operator</option>
                </select>
              </div>
              <div className="form-group">
                <label>Password {user && '(leave empty to keep current)'}</label>
                <input
                  type="password"
                  value={formData.password}
                  onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                  placeholder={user ? "Leave empty to keep current" : "Enter password"}
                />
              </div>
            </div>
            <div className="form-group">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={formData.is_active}
                  onChange={(e) => setFormData(prev => ({ ...prev, is_active: e.target.checked }))}
                />
                Active User
              </label>
            </div>
          </div>

          {/* Module Access */}
          <div className="form-section">
            <h3>Module Access</h3>
            <div className="permissions-grid">
              {modules.map(module => (
                <div key={module.key} className="permission-item">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      checked={formData.permissions.modules[module.key]}
                      onChange={(e) => handleModuleChange(module.key, e.target.checked)}
                    />
                    <span className="module-icon">{module.icon}</span>
                    {module.label}
                  </label>
                </div>
              ))}
            </div>
          </div>

          {/* Action Permissions */}
          <div className="form-section">
            <h3>Action Permissions</h3>
            <div className="actions-table">
              <div className="actions-header">
                <div className="module-col">Module</div>
                {actions.map(action => (
                  <div key={action.key} className="action-col">
                    <span className="action-icon">{action.icon}</span>
                    {action.label}
                  </div>
                ))}
              </div>
              {modules.filter(m => m.key !== 'dashboard').map(module => (
                <div key={module.key} className="actions-row">
                  <div className="module-col">
                    <span className="module-icon">{module.icon}</span>
                    {module.label}
                  </div>
                  {actions.map(action => (
                    <div key={action.key} className="action-col">
                      <input
                        type="checkbox"
                        checked={formData.permissions.actions[module.key]?.[action.key] || false}
                        onChange={(e) => handleActionChange(module.key, action.key, e.target.checked)}
                        disabled={!formData.permissions.modules[module.key]}
                      />
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>

          {/* Company Access */}
          <div className="form-section">
            <h3>Company Access</h3>
            <div className="access-grid">
              {companiesLocations.companies.map(company => (
                <div key={company.id} className="access-item">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      checked={formData.permissions.accessible_companies.includes(company.id)}
                      onChange={(e) => handleCompanyChange(company.id, e.target.checked)}
                    />
                    üè¢ {company.name}
                  </label>
                </div>
              ))}
            </div>
          </div>

          {/* Location Access */}
          <div className="form-section">
            <h3>Location Access</h3>
            <div className="access-grid">
              {companiesLocations.locations.map(location => (
                <div key={location.id} className="access-item">
                  <label className="checkbox-label">
                    <input
                      type="checkbox"
                      checked={formData.permissions.accessible_locations.includes(location.id)}
                      onChange={(e) => handleLocationChange(location.id, e.target.checked)}
                    />
                    üìç {location.name}
                  </label>
                </div>
              ))}
            </div>
          </div>

          <div className="form-actions">
            <button type="button" onClick={onClose} className="btn-cancel">
              Cancel
            </button>
            <button type="submit" className="btn-save">
              {user ? 'Update User' : 'Create User'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Dashboard Component
const Dashboard = () => {
  const { user, logout } = useAuth();
  const [stats, setStats] = useState(null);
  const [companies, setCompanies] = useState([]);
  const [locations, setLocations] = useState([]);
  const [providers, setProviders] = useState([]);
  const [cabinets, setCabinets] = useState([]);
  const [slotMachines, setSlotMachines] = useState([]);
  const [gameMixes, setGameMixes] = useState([]);
  const [invoices, setInvoices] = useState([]);
  const [onjnReports, setOnjnReports] = useState([]);
  const [legalDocuments, setLegalDocuments] = useState([]);
  const [users, setUsers] = useState([]);
  const [editingUser, setEditingUser] = useState(null);
  const [showUserForm, setShowUserForm] = useState(false);
  const [editingEntity, setEditingEntity] = useState(null);
  const [showEntityForm, setShowEntityForm] = useState(false);
  const [entityType, setEntityType] = useState('');
  const [companiesLocations, setCompaniesLocations] = useState({ companies: [], locations: [] });
  const [activeView, setActiveView] = useState('dashboard');
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = async () => {
    try {
      const token = localStorage.getItem('token');
      const headers = { Authorization: `Bearer ${token}` };
      
      const [statsRes, companiesRes, locationsRes, providersRes, cabinetsRes, slotMachinesRes, gameMixesRes, invoicesRes, onjnRes, legalRes, usersRes, adminDataRes] = await Promise.all([
        fetch(`${API}/dashboard/stats`, { headers }),
        fetch(`${API}/companies`, { headers }),
        fetch(`${API}/locations`, { headers }),
        fetch(`${API}/providers`, { headers }),
        fetch(`${API}/cabinets`, { headers }),
        fetch(`${API}/slot-machines`, { headers }),
        fetch(`${API}/game-mixes`, { headers }),
        fetch(`${API}/invoices`, { headers }),
        fetch(`${API}/onjn-reports`, { headers }),
        fetch(`${API}/legal-documents`, { headers }),
        user?.role === 'admin' ? fetch(`${API}/users`, { headers }) : Promise.resolve({ json: () => [] }),
        user?.role === 'admin' ? fetch(`${API}/admin/companies-locations`, { headers }) : Promise.resolve({ json: () => ({ companies: [], locations: [] }) })
      ]);
      
      const [statsData, companiesData, locationsData, providersData, cabinetsData, slotMachinesData, gameMixesData, invoicesData, onjnData, legalData, usersData, adminData] = await Promise.all([
        statsRes.json(),
        companiesRes.json(),
        locationsRes.json(),
        providersRes.json(),
        cabinetsRes.json(),
        slotMachinesRes.json(),
        gameMixesRes.json(),
        invoicesRes.json(),
        onjnRes.json(),
        legalRes.json(),
        usersRes.json ? usersRes.json() : [],
        adminDataRes.json ? adminDataRes.json() : { companies: [], locations: [] }
      ]);
      
      setStats(statsData);
      setCompanies(companiesData);
      setLocations(locationsData);
      setProviders(providersData);
      setCabinets(cabinetsData);
      setSlotMachines(slotMachinesData);
      setGameMixes(gameMixesData);
      setInvoices(invoicesData);
      setOnjnReports(onjnData);
      setLegalDocuments(legalData);
      setUsers(usersData);
      setCompaniesLocations(adminData);
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
    } finally {
      setLoading(false);
    }
  };

  // Navigation items
  const navigationItems = [
    { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
    { id: 'companies', label: 'Companies', icon: 'üè¢', count: companies.length },
    { id: 'locations', label: 'Locations', icon: 'üìç', count: locations.length },
    { id: 'providers', label: 'Providers', icon: 'üéÆ', count: providers.length },
    { id: 'cabinets', label: 'Cabinets', icon: 'üé∞', count: cabinets.length },
    { id: 'gamemixes', label: 'Game Mixes', icon: 'üé≤', count: gameMixes.length },
    { id: 'slots', label: 'Slots', icon: 'üéØ', count: slotMachines.length },
    { id: 'invoices', label: 'Invoices', icon: 'üí∞', count: invoices.length },
    { id: 'onjn', label: 'ONJN Reports', icon: 'üìã', count: onjnReports.length },
    { id: 'legal', label: 'Legal Documents', icon: 'üìÑ', count: legalDocuments.length },
    ...(user?.role === 'admin' ? [{ id: 'users', label: 'Users', icon: 'üë•', count: users.length }] : []),
  ];

  const handleEditUser = (userData) => {
    setEditingUser(userData);
    setShowUserForm(true);
  };

  const handleCloseUserForm = () => {
    setEditingUser(null);
    setShowUserForm(false);
  };

  const handleSaveUser = async (userData) => {
    try {
      const token = localStorage.getItem('token');
      const method = editingUser ? 'PUT' : 'POST';
      const url = editingUser ? `${API}/users/${editingUser.id}` : `${API}/users`;
      
      const response = await fetch(url, {
        method,
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(userData)
      });

      if (response.ok) {
        await fetchDashboardData(); // Refresh data
        handleCloseUserForm();
      } else {
        console.error('Failed to save user');
      }
    } catch (error) {
      console.error('Error saving user:', error);
    }
  };

  // Generic entity handlers
  const handleAddEntity = (type) => {
    setEntityType(type);
    setEditingEntity(null);
    setShowEntityForm(true);
  };

  const handleEditEntity = (entityData, type) => {
    setEntityType(type);
    setEditingEntity(entityData);
    setShowEntityForm(true);
  };

  const handleCloseEntityForm = () => {
    setEditingEntity(null);
    setShowEntityForm(false);
    setEntityType('');
  };

  const handleSaveEntity = async (entityData) => {
    try {
      const token = localStorage.getItem('token');
      const method = editingEntity ? 'PUT' : 'POST';
      const endpoint = getEntityEndpoint(entityType);
      const url = editingEntity ? `${API}/${endpoint}/${editingEntity.id}` : `${API}/${endpoint}`;
      
      const response = await fetch(url, {
        method,
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(entityData)
      });

      if (response.ok) {
        await fetchDashboardData(); // Refresh data
        handleCloseEntityForm();
      } else {
        const error = await response.json();
        console.error('Failed to save entity:', error);
        alert(error.detail || 'Failed to save entity');
      }
    } catch (error) {
      console.error('Error saving entity:', error);
      alert('Error saving entity');
    }
  };

  const handleDeleteEntity = async (entityId, type) => {
    if (!confirm('Are you sure you want to delete this item?')) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const endpoint = getEntityEndpoint(type);
      const response = await fetch(`${API}/${endpoint}/${entityId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (response.ok) {
        await fetchDashboardData(); // Refresh data
      } else {
        const error = await response.json();
        alert(error.detail || 'Failed to delete entity');
      }
    } catch (error) {
      console.error('Error deleting entity:', error);
      alert('Error deleting entity');
    }
  };

  const getEntityEndpoint = (type) => {
    const endpoints = {
      'companies': 'companies',
      'locations': 'locations',
      'providers': 'providers',
      'cabinets': 'cabinets',
      'slots': 'slot-machines',
      'gamemixes': 'game-mixes',
      'invoices': 'invoices',
      'onjn': 'onjn-reports',
      'legal': 'legal-documents'
    };
    return endpoints[type] || type;
  };

  const renderTable = (title, data, columns, actions) => (
    <div className="table-container">
      <div className="table-header">
        <h2>{title}</h2>
        <div className="table-actions">
          <button 
            className="btn-primary"
            onClick={() => actions?.onAdd && actions.onAdd()}
          >
            <span className="icon">‚ûï</span>
            Add {title.slice(0, -1)}
          </button>
        </div>
      </div>
      
      <div className="table-wrapper">
        <table className="data-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" />
              </th>
              <th>#</th>
              {columns.map(col => (
                <th key={col.key}>{col.label}</th>
              ))}
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {data.length === 0 ? (
              <tr>
                <td colSpan={columns.length + 3} className="empty-row">
                  No {title.toLowerCase()} found
                </td>
              </tr>
            ) : (
              data.map((item, index) => (
                <tr key={item.id}>
                  <td>
                    <input type="checkbox" />
                  </td>
                  <td>{index + 1}</td>
                  {columns.map(col => (
                    <td key={col.key}>
                      {col.render ? col.render(item) : item[col.key] || 'N/A'}
                    </td>
                  ))}
                  <td>
                    <span className={`status-badge ${item.status || 'active'}`}>
                      {(item.status || 'active').toUpperCase()}
                    </span>
                  </td>
                  <td>
                    <div className="action-buttons">
                      <button 
                        className="btn-action btn-edit" 
                        title="Edit"
                        onClick={() => actions?.onEdit && actions.onEdit(item)}
                      >
                        ‚úèÔ∏è
                      </button>
                      <button 
                        className="btn-action btn-delete" 
                        title="Delete"
                        onClick={() => actions?.onDelete && actions.onDelete(item.id)}
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
      
      {data.length > 0 && (
        <div className="table-footer">
          <span>Showing 1 to {data.length} of {data.length} entries</span>
          <div className="pagination">
            <button className="btn-pagination">Previous</button>
            <button className="btn-pagination active">1</button>
            <button className="btn-pagination">Next</button>
          </div>
        </div>
      )}
    </div>
  );

  const renderDashboard = () => (
    <div className="dashboard-overview">
      <div className="dashboard-header">
        <h1>Financial Planner Pro</h1>
        <p>Gaming Industry Management System</p>
      </div>
      
      {stats && (
        <div className="stats-grid">
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#3b82f6' }}>üìä</div>
            <div className="stat-content">
              <h3>Total Companies</h3>
              <p className="stat-value">{stats.total_companies}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#10b981' }}>üìç</div>
            <div className="stat-content">
              <h3>Total Locations</h3>
              <p className="stat-value">{stats.total_locations}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#f59e0b' }}>üéÆ</div>
            <div className="stat-content">
              <h3>Gaming Providers</h3>
              <p className="stat-value">{stats.total_providers}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#ef4444' }}>üé∞</div>
            <div className="stat-content">
              <h3>Gaming Cabinets</h3>
              <p className="stat-value">{stats.total_cabinets}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#8b5cf6' }}>üéØ</div>
            <div className="stat-content">
              <h3>Slot Machines</h3>
              <p className="stat-value">{stats.total_slot_machines}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#06b6d4' }}>‚ö°</div>
            <div className="stat-content">
              <h3>Active Equipment</h3>
              <p className="stat-value">{stats.active_equipment}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#f59e0b' }}>üí∞</div>
            <div className="stat-content">
              <h3>Invoices</h3>
              <p className="stat-value">{stats.total_invoices}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#10b981' }}>üìã</div>
            <div className="stat-content">
              <h3>ONJN Reports</h3>
              <p className="stat-value">{stats.total_onjn_reports}</p>
            </div>
          </div>
          <div className="stat-card">
            <div className="stat-icon" style={{ backgroundColor: '#ef4444' }}>üìÑ</div>
            <div className="stat-content">
              <h3>Legal Documents</h3>
              <p className="stat-value">{stats.total_legal_documents}</p>
            </div>
          </div>
          {user?.role === 'admin' && (
            <div className="stat-card">
              <div className="stat-icon" style={{ backgroundColor: '#8b5cf6' }}>üë•</div>
              <div className="stat-content">
                <h3>Total Users</h3>
                <p className="stat-value">{stats.total_users}</p>
              </div>
            </div>
          )}
        </div>
      )}

      {stats && stats.recent_activities.length > 0 && (
        <div className="recent-activities">
          <h3>Recent Activities</h3>
          <div className="activities-list">
            {stats.recent_activities.map((activity, index) => (
              <div key={index} className="activity-item">
                <div className="activity-icon">
                  {activity.type === 'company' && 'üè¢'}
                  {activity.type === 'location' && 'üìç'}
                  {activity.type === 'provider' && 'üéÆ'}
                  {activity.type === 'cabinet' && 'üé∞'}
                </div>
                <div className="activity-details">
                  <p><strong>{activity.name}</strong> was {activity.action}</p>
                  <p className="activity-date">{new Date(activity.date).toLocaleDateString()}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  const renderContent = () => {
    switch (activeView) {
      case 'dashboard':
        return renderDashboard();
      case 'companies':
        return renderTable('Companies', companies, [
          { key: 'name', label: 'Company Name' },
          { key: 'registration_number', label: 'Registration' },
          { key: 'contact_person', label: 'Contact Person' },
          { key: 'email', label: 'Email' },
          { key: 'phone', label: 'Phone' }
        ], { 
          onAdd: () => handleAddEntity('companies'),
          onEdit: (item) => handleEditEntity(item, 'companies'),
          onDelete: (id) => handleDeleteEntity(id, 'companies')
        });
      case 'locations':
        return renderTable('Locations', locations, [
          { key: 'name', label: 'Location Name' },
          { key: 'address', label: 'Address' },
          { key: 'city', label: 'City' },
          { key: 'county', label: 'County' },
          { 
            key: 'coordinates', 
            label: 'Coordinates',
            render: (item) => item.latitude && item.longitude ? 
              `${item.latitude.toFixed(4)}, ${item.longitude.toFixed(4)}` : 'N/A'
          }
        ], { 
          onAdd: () => handleAddEntity('locations'),
          onEdit: (item) => handleEditEntity(item, 'locations'),
          onDelete: (id) => handleDeleteEntity(id, 'locations')
        });
      case 'providers':
        return renderTable('Providers', providers, [
          { key: 'name', label: 'Provider Name' },
          { key: 'company_name', label: 'Company' },
          { key: 'contact_person', label: 'Contact Person' },
          { key: 'email', label: 'Email' },
          { 
            key: 'website', 
            label: 'Website',
            render: (item) => item.website ? 
              <a href={item.website} target="_blank" rel="noopener noreferrer" className="link">
                {item.website}
              </a> : 'N/A'
          }
        ], { 
          onAdd: () => handleAddEntity('providers'),
          onEdit: (item) => handleEditEntity(item, 'providers'),
          onDelete: (id) => handleDeleteEntity(id, 'providers')
        });
      case 'cabinets':
        return renderTable('Cabinets', cabinets, [
          { key: 'serial_number', label: 'Serial Number' },
          { key: 'manufacturer', label: 'Manufacturer' },
          { key: 'model', label: 'Model' },
          { 
            key: 'installation_date', 
            label: 'Installation Date',
            render: (item) => item.installation_date ? 
              new Date(item.installation_date).toLocaleDateString() : 'N/A'
          },
          { 
            key: 'last_maintenance', 
            label: 'Last Maintenance',
            render: (item) => item.last_maintenance ? 
              new Date(item.last_maintenance).toLocaleDateString() : 'N/A'
          }
        ], { 
          onAdd: () => handleAddEntity('cabinets'),
          onEdit: (item) => handleEditEntity(item, 'cabinets'),
          onDelete: (id) => handleDeleteEntity(id, 'cabinets')
        });
      case 'slots':
        return renderTable('Slot Machines', slotMachines, [
          { key: 'model', label: 'Model' },
          { 
            key: 'denomination', 
            label: 'Denomination',
            render: (item) => `${item.denomination}‚Ç¨`
          },
          { 
            key: 'max_bet', 
            label: 'Max Bet',
            render: (item) => `${item.max_bet}‚Ç¨`
          },
          { 
            key: 'rtp', 
            label: 'RTP',
            render: (item) => `${item.rtp}%`
          },
          { key: 'gaming_places', label: 'Gaming Places' }
        ], { 
          onAdd: () => handleAddEntity('slots'),
          onEdit: (item) => handleEditEntity(item, 'slots'),
          onDelete: (id) => handleDeleteEntity(id, 'slots')
        });
      case 'gamemixes':
        return renderTable('Game Mixes', gameMixes, [
          { key: 'name', label: 'Mix Name' },
          { key: 'description', label: 'Description' },
          { key: 'game_count', label: 'Game Count' },
          { 
            key: 'games', 
            label: 'Top Games',
            render: (item) => item.games.slice(0, 3).join(', ') + 
              (item.games.length > 3 ? '...' : '')
          }
        ], { 
          onAdd: () => handleAddEntity('gamemixes'),
          onEdit: (item) => handleEditEntity(item, 'gamemixes'),
          onDelete: (id) => handleDeleteEntity(id, 'gamemixes')
        });
      case 'invoices':
        return renderTable('Invoices', invoices, [
          { key: 'invoice_number', label: 'Invoice Number' },
          { 
            key: 'issue_date', 
            label: 'Issue Date',
            render: (item) => new Date(item.issue_date).toLocaleDateString()
          },
          { 
            key: 'due_date', 
            label: 'Due Date',
            render: (item) => new Date(item.due_date).toLocaleDateString()
          },
          { 
            key: 'amount', 
            label: 'Amount',
            render: (item) => `${item.amount} ${item.currency}`
          },
          { key: 'description', label: 'Description' }
        ], { 
          onAdd: () => handleAddEntity('invoices'),
          onEdit: (item) => handleEditEntity(item, 'invoices'),
          onDelete: (id) => handleDeleteEntity(id, 'invoices')
        });
      case 'onjn':
        return renderTable('ONJN Reports', onjnReports, [
          { key: 'report_number', label: 'Report Number' },
          { key: 'report_type', label: 'Type' },
          { 
            key: 'report_date', 
            label: 'Report Date',
            render: (item) => new Date(item.report_date).toLocaleDateString()
          },
          { 
            key: 'submission_date', 
            label: 'Submitted',
            render: (item) => item.submission_date ? 
              new Date(item.submission_date).toLocaleDateString() : 'Not submitted'
          }
        ], { 
          onAdd: () => handleAddEntity('onjn'),
          onEdit: (item) => handleEditEntity(item, 'onjn'),
          onDelete: (id) => handleDeleteEntity(id, 'onjn')
        });
      case 'legal':
        return renderTable('Legal Documents', legalDocuments, [
          { key: 'title', label: 'Document Title' },
          { key: 'document_type', label: 'Type' },
          { key: 'issuing_authority', label: 'Issuing Authority' },
          { 
            key: 'issue_date', 
            label: 'Issue Date',
            render: (item) => new Date(item.issue_date).toLocaleDateString()
          },
          { 
            key: 'expiry_date', 
            label: 'Expiry Date',
            render: (item) => item.expiry_date ? 
              new Date(item.expiry_date).toLocaleDateString() : 'No expiry'
          }
        ], { 
          onAdd: () => handleAddEntity('legal'),
          onEdit: (item) => handleEditEntity(item, 'legal'),
          onDelete: (id) => handleDeleteEntity(id, 'legal')
        });
      case 'users':
        return renderTable('Users', users, [
          { key: 'username', label: 'Username' },
          { key: 'email', label: 'Email' },
          { key: 'role', label: 'Role' },
          { 
            key: 'assigned_locations', 
            label: 'Assigned Locations',
            render: (item) => {
              if (item.role === 'admin') return 'All Locations';
              if (!item.assigned_locations || item.assigned_locations.length === 0) return 'No Locations';
              return `${item.assigned_locations.length} Location(s)`;
            }
          },
          { 
            key: 'created_at', 
            label: 'Created',
            render: (item) => new Date(item.created_at).toLocaleDateString()
          },
          { 
            key: 'is_active', 
            label: 'Active',
            render: (item) => item.is_active ? 'Yes' : 'No'
          }
        ], { 
          onAdd: () => {
            setEditingUser(null);
            setShowUserForm(true);
          },
          onEdit: handleEditUser,
          onDelete: (id) => handleDeleteEntity(id, 'users')
        });
      default:
        return renderDashboard();
    }
  };

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Loading dashboard...</p>
      </div>
    );
  }

  return (
    <div className="app-layout">
      {/* Sidebar */}
      <div className="sidebar">
        <div className="sidebar-header">
          <div className="logo">
            <h2>FINANCIAL PLANNER PRO</h2>
            <p>Gaming Management System</p>
          </div>
        </div>
        
        <nav className="sidebar-nav">
          {navigationItems.map(item => (
            <button
              key={item.id}
              className={`nav-item ${activeView === item.id ? 'active' : ''}`}
              onClick={() => setActiveView(item.id)}
            >
              <span className="nav-icon">{item.icon}</span>
              <span className="nav-label">{item.label}</span>
              {item.count !== undefined && (
                <span className="nav-count">{item.count}</span>
              )}
            </button>
          ))}
        </nav>
        
        <div className="sidebar-footer">
          <div className="user-info">
            <div className="user-avatar">
              {user?.username?.charAt(0).toUpperCase()}
            </div>
            <div className="user-details">
              <span className="user-name">{user?.username}</span>
              <span className="user-role">{user?.role}</span>
            </div>
          </div>
          <button onClick={logout} className="logout-btn">
            üö™
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className="main-content">
        <div className="content-header">
          <div className="breadcrumb">
            <span>Financial Planner Pro</span>
            <span className="separator">‚Ä∫</span>
            <span>{navigationItems.find(item => item.id === activeView)?.label || 'Dashboard'}</span>
          </div>
          <div className="header-actions">
            <span className="welcome-text">Welcome, {user?.username}</span>
          </div>
        </div>
        
        <div className="content-body">
          {renderContent()}
        </div>
      </div>
      
      {/* Entity Form Modal */}
      {showEntityForm && (
        <EntityForm
          entityType={entityType}
          entity={editingEntity}
          onSave={handleSaveEntity}
          onClose={handleCloseEntityForm}
          companiesLocations={companiesLocations}
          providers={providers}
          cabinets={cabinets}
          gameMixes={gameMixes}
        />
      )}
      
      {/* User Edit Modal */}
      {showUserForm && (
        <UserEditForm
          user={editingUser}
          onSave={handleSaveUser}
          onClose={handleCloseUserForm}
          companiesLocations={companiesLocations}
        />
      )}
    </div>
  );
};

// Main App Component
const App = () => {
  return (
    <AuthProvider>
      <AppContent />
    </AuthProvider>
  );
};

const AppContent = () => {
  const { user, loading } = useAuth();

  if (loading) {
    return (
      <div className="loading-container">
        <div className="loading-spinner"></div>
        <p>Loading application...</p>
      </div>
    );
  }

  return (
    <div className="App">
      {user ? <Dashboard /> : <Login />}
    </div>
  );
};

export default App;